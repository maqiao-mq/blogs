# 内存散装知识点记录

## munmap 和 madvise

munmap() 在调用的时候，会尽可能把不用的 page table 给释放掉。

madvise() 有两个flag：

- MADV_DONTNEED，表示用户态不再需要这块内存了，内核在处理的时候，会直接无视内存是否脏页而回收掉。如果后续又去访问这块内存的话，会触发 page fault，然后系统会重新分配一块内存出来。
- MADV_FREE，也和MADV_DONTNEED一样，直接回收，区别是它会lazy free，也就是并不会立即回收，而是在系统内存不够的时候再来回收。而且，期间如果又对这块内存进行了写入动作的话，就会取消回收。

madvise的两个flag，和munamp的区别，在于madvise()目前是不会主动释放page table的，但是貌似upstream有补丁在尝试增加回收page table的能力。

jemalloc和tcmalloc一般会先用 madvise 来回收内存，最后才会用 munmap() 来彻底回收。
